<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>内核中的guard宏 | YZWDDSG</title>
  <meta name="keywords" content="">
  <meta name="description" content="内核中的guard宏 | YZWDDSG">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="google-site-verification" content="xxJB9SNPOytyUXCA2HZ6ZgNbI5iEx6C2GX3XuMKlBv0" />
<meta name="description" content="邮箱：857879363@qq.com bilibili：https:&#x2F;&#x2F;space.bilibili.com&#x2F;346090747 知乎：https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;zhong-ai-83-43 公众号： 本模板链接：3-hexo 本模板原作者：yelog">
<meta property="og:type" content="website">
<meta property="og:title" content="YZWDDSG">
<meta property="og:url" content="http://example.com/about/index.html">
<meta property="og:site_name" content="YZWDDSG">
<meta property="og:description" content="邮箱：857879363@qq.com bilibili：https:&#x2F;&#x2F;space.bilibili.com&#x2F;346090747 知乎：https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;zhong-ai-83-43 公众号： 本模板链接：3-hexo 本模板原作者：yelog">
<meta property="og:locale">
<meta property="og:image" content="https://github.com/yzwddsg-plus/picx-images-hosting/raw/master/image.70ahjnzuub.webp">
<meta property="article:published_time" content="2025-03-09T15:08:19.494Z">
<meta property="article:modified_time" content="2025-03-09T15:08:19.494Z">
<meta property="article:author" content="YZWDDSG">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/yzwddsg-plus/picx-images-hosting/raw/master/image.70ahjnzuub.webp">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-dark.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>
<script src="/js/custom-iconfont.js?v=1.1.0" ></script>


<meta name="generator" content="Hexo 7.3.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>YZWDDSG</span>
</div>

<div class="icon">
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
</div>





<ul>
    <li>
        <div class="all active" data-rel="All">All
            
                <small>(34)</small>
            
        </div>
    </li>
    
        
            
                
    <li>
        <div data-rel="硬件">
            
            硬件
            <small>(4)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="调度">
            
            调度
            <small>(2)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="内存">
            
            内存
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="存储">
            
            存储
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="网络">
            
            网络
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="文件系统">
            
            文件系统
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="虚拟化">
            
            虚拟化
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="power">
            
            power
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="OS">
            
            OS
            <small>(3)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="故障排查">
            
            故障排查
            <small>(11)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="其他">
            
            其他
            <small>(5)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="个人">
            
            个人
            <small>(3)</small>
        </div>
        
    </li>

            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  site_url"
               
               href="/about">About</a>
        
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="34">
<input type="hidden" id="yelog_site_word_count" value="78.9k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="search shortcut key i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="switch to outline view shortcut key w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="return"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="case sensitive"></i>
            <i class="iconfont icon-tag" data-title="label"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">outline</div>
            <i class="iconfont icon-list" data-title="switch to article list"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        
        <a  class="All 故障排查 "
           href="/2026/01/30/%E7%BD%91%E5%8D%A1%E9%A9%B1%E5%8A%A8probe%E5%A4%B1%E8%B4%A5/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="网卡驱动probe失败">网卡驱动probe失败</span>
            <span class="post-date" title="2026-01-30 20:50:05">2026/01/30</span>
        </a>
        
        
        <a  class="All 故障排查 "
           href="/2025/11/18/fsnotify%E5%AF%BC%E8%87%B4%E7%9A%84softlockup/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="fsnotify导致的softlockup">fsnotify导致的softlockup</span>
            <span class="post-date" title="2025-11-18 23:53:46">2025/11/18</span>
        </a>
        
        
        <a  class="All 其他 "
           href="/2025/11/02/%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84guard%E5%AE%8F/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="内核中的guard宏">内核中的guard宏</span>
            <span class="post-date" title="2025-11-02 22:49:38">2025/11/02</span>
        </a>
        
        
        <a  class="All 故障排查 "
           href="/2025/10/26/CPU%E6%8A%96%E5%8A%A8%E5%8E%9F%E5%9B%A0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="CPU抖动原因">CPU抖动原因</span>
            <span class="post-date" title="2025-10-26 23:34:25">2025/10/26</span>
        </a>
        
        
        <a  class="All 其他 "
           href="/2025/10/19/%E6%9F%A5%E7%9C%8Binitramfs/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="查看initramfs">查看initramfs</span>
            <span class="post-date" title="2025-10-19 23:28:27">2025/10/19</span>
        </a>
        
        
        <a  class="All 其他 "
           href="/2025/08/18/%E4%B8%80%E4%B8%AAFPU%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98%E7%9A%84%E4%BF%AE%E5%A4%8D-without-kdump/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="一个FPU相关问题的修复---without kdump">一个FPU相关问题的修复---without kdump</span>
            <span class="post-date" title="2025-08-18 21:53:35">2025/08/18</span>
        </a>
        
        
        <a  class="All 故障排查 "
           href="/2025/07/04/kdump%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="kdump失败问题排查">kdump失败问题排查</span>
            <span class="post-date" title="2025-07-04 23:03:39">2025/07/04</span>
        </a>
        
        
        <a  class="All 个人 "
           href="/2025/06/13/%E8%AE%B0%E4%B8%80%E5%8F%AA%E6%B5%81%E6%B5%AA%E6%96%91%E7%82%B9%E7%8B%97/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="记一只流浪斑点狗">记一只流浪斑点狗</span>
            <span class="post-date" title="2025-06-13 21:39:16">2025/06/13</span>
        </a>
        
        
        <a  class="All 硬件 "
           href="/2025/05/28/AMD-ERAPS/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="AMD ERAPS">AMD ERAPS</span>
            <span class="post-date" title="2025-05-28 21:52:56">2025/05/28</span>
        </a>
        
        
        <a  class="All 其他 "
           href="/2025/04/26/popen%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98%E5%8F%8A%E5%88%86%E6%9E%90/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="popen导致的问题及分析">popen导致的问题及分析</span>
            <span class="post-date" title="2025-04-26 23:15:08">2025/04/26</span>
        </a>
        
        
        <a  class="All 存储 "
           href="/2025/04/20/nbd%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%AE%9E%E7%8E%B0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="nbd驱动的实现">nbd驱动的实现</span>
            <span class="post-date" title="2025-04-20 16:41:42">2025/04/20</span>
        </a>
        
        
        <a  class="All 内存 "
           href="/2025/04/11/%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3meminfo%E4%B8%AD%E7%9A%84MemAvailable%E5%92%8CMemFree/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="如何理解meminfo中的MemAvailable和MemFree">如何理解meminfo中的MemAvailable和MemFree</span>
            <span class="post-date" title="2025-04-11 19:43:19">2025/04/11</span>
        </a>
        
        
        <a  class="All 故障排查 "
           href="/2025/04/09/%E6%89%A7%E8%A1%8Crpm%E5%91%BD%E4%BB%A4%E5%8D%A1%E6%AD%BB%E6%8E%92%E6%9F%A5/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="执行rpm命令卡死排查">执行rpm命令卡死排查</span>
            <span class="post-date" title="2025-04-09 22:11:15">2025/04/09</span>
        </a>
        
        
        <a  class="All 调度 "
           href="/2025/04/07/CPU%E5%88%A9%E7%94%A8%E7%8E%87%E4%B8%8D%E5%9D%87%E8%A1%A1%E9%97%AE%E9%A2%98-sched-domain%E5%AD%A6%E4%B9%A0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="CPU利用率不均衡问题-sched_domain学习">CPU利用率不均衡问题-sched_domain学习</span>
            <span class="post-date" title="2025-04-07 22:04:47">2025/04/07</span>
        </a>
        
        
        <a  class="All 硬件 "
           href="/2025/04/05/PCIE%E8%AE%BE%E5%A4%87%E7%83%AD%E6%8F%92%E6%8B%94/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="PCIE设备热插拔">PCIE设备热插拔</span>
            <span class="post-date" title="2025-04-05 22:00:12">2025/04/05</span>
        </a>
        
        
        <a  class="All 个人 "
           href="/2025/04/03/%E6%88%91%E5%92%8C%E6%88%91%E7%9A%84%E7%8B%97%E5%AD%90%E4%BB%AC/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="我和我的狗子们">我和我的狗子们</span>
            <span class="post-date" title="2025-04-03 22:18:32">2025/04/03</span>
        </a>
        
        
        <a  class="All 调度 "
           href="/2025/03/31/%E4%BF%AE%E6%94%B9%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF%E7%9A%84%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="修改进程信息的内核模块">修改进程信息的内核模块</span>
            <span class="post-date" title="2025-03-31 21:53:34">2025/03/31</span>
        </a>
        
        
        <a  class="All 故障排查 "
           href="/2025/03/30/%E4%B8%80%E6%AC%A1%E4%B8%A2%E5%8C%85%E7%9A%84%E6%8E%92%E6%9F%A5/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="一次丢包的排查">一次丢包的排查</span>
            <span class="post-date" title="2025-03-30 12:56:05">2025/03/30</span>
        </a>
        
        
        <a  class="All 故障排查 "
           href="/2025/03/29/systemd-resolved%E6%9C%8D%E5%8A%A1%E5%BC%82%E5%B8%B8/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="systemd-resolved服务异常">systemd-resolved服务异常</span>
            <span class="post-date" title="2025-03-29 22:28:32">2025/03/29</span>
        </a>
        
        
        <a  class="All 故障排查 "
           href="/2025/03/22/rt%E8%B0%83%E5%BA%A6%E5%99%A8bug%E5%AF%BC%E8%87%B4%E5%AE%95%E6%9C%BA%E7%9A%84%E6%8E%92%E6%9F%A5/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="rt调度器bug导致宕机的排查">rt调度器bug导致宕机的排查</span>
            <span class="post-date" title="2025-03-22 21:08:39">2025/03/22</span>
        </a>
        
        
        <a  class="All OS "
           href="/2025/03/21/%E4%BF%AE%E6%94%B9debian%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E5%B9%B6%E6%89%93%E5%8C%85/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="修改debian内核源码并打包">修改debian内核源码并打包</span>
            <span class="post-date" title="2025-03-21 21:53:56">2025/03/21</span>
        </a>
        
        
        <a  class="All 故障排查 "
           href="/2025/03/17/%E8%AE%B0%E4%B8%80%E6%AC%A1%E4%BA%91%E7%9B%98%E7%83%AD%E6%8B%94%E5%A4%B1%E8%B4%A5/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="记一次云盘热拔失败">记一次云盘热拔失败</span>
            <span class="post-date" title="2025-03-17 22:02:52">2025/03/17</span>
        </a>
        
        
        <a  class="All 硬件 "
           href="/2025/03/13/MMX%E3%80%81FMA%E3%80%81SSE%E4%B8%8EAVX/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="MMX、FMA、SSE与AVX">MMX、FMA、SSE与AVX</span>
            <span class="post-date" title="2025-03-13 21:37:54">2025/03/13</span>
        </a>
        
        
        <a  class="All 文件系统 "
           href="/2025/03/12/proc%E3%80%81sysctl%E5%92%8Csysfs/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="proc、sysctl和sysfs">proc、sysctl和sysfs</span>
            <span class="post-date" title="2025-03-12 22:00:23">2025/03/12</span>
        </a>
        
        
        <a  class="All 其他 "
           href="/2025/03/11/%E4%BF%AE%E6%94%B9bios%E9%85%8D%E7%BD%AE/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="修改bios配置">修改bios配置</span>
            <span class="post-date" title="2025-03-11 21:49:28">2025/03/11</span>
        </a>
        
        
        <a  class="All OS "
           href="/2025/03/10/%E4%BF%AE%E6%94%B9%E5%85%AC%E7%89%88%E5%86%85%E6%A0%B8/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="修改公版内核">修改公版内核</span>
            <span class="post-date" title="2025-03-10 22:13:00">2025/03/10</span>
        </a>
        
        
        <a  class="All power "
           href="/2025/03/09/proc-cpuinfo%E6%98%BE%E7%A4%BA%E9%A2%91%E7%8E%87%E5%8E%9F%E7%90%86/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="/proc/cpuinfo显示频率原理">/proc/cpuinfo显示频率原理</span>
            <span class="post-date" title="2025-03-09 22:00:49">2025/03/09</span>
        </a>
        
        
        <a  class="All OS "
           href="/2025/03/07/rsyslog%E9%85%8D%E7%BD%AE/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="rsyslog配置">rsyslog配置</span>
            <span class="post-date" title="2025-03-07 22:36:29">2025/03/07</span>
        </a>
        
        
        <a  class="All 虚拟化 "
           href="/2025/03/06/qemu-kvm%E6%B7%BB%E5%8A%A0%E6%96%B0feature%E8%99%9A%E6%8B%9F%E5%8C%96/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="qemu kvm添加新feature虚拟化">qemu kvm添加新feature虚拟化</span>
            <span class="post-date" title="2025-03-06 00:13:34">2025/03/06</span>
        </a>
        
        
        <a  class="All 故障排查 "
           href="/2025/02/27/hung-task%E5%8E%9F%E7%90%86/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="hung task原理">hung task原理</span>
            <span class="post-date" title="2025-02-27 22:54:58">2025/02/27</span>
        </a>
        
        
        <a  class="All 硬件 "
           href="/2025/02/26/netconsole/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="netconsole">netconsole</span>
            <span class="post-date" title="2025-02-26 23:01:56">2025/02/26</span>
        </a>
        
        
        <a  class="All 个人 "
           href="/2025/02/26/%E8%88%92%E6%B4%BB%E8%88%92%E6%B4%BB%E7%AD%8B%E9%AA%A8%EF%BC%8C%E6%8A%96%E6%93%9E%E6%8A%96%E6%93%9E%E7%B2%BE%E7%A5%9E/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="舒活舒活筋骨，抖擞抖擞精神">舒活舒活筋骨，抖擞抖擞精神</span>
            <span class="post-date" title="2025-02-26 00:05:33">2025/02/26</span>
        </a>
        
        
        <a  class="All 故障排查 "
           href="/2025/02/25/softlockup%E4%B8%8Ehardlockup/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="softlockup与hardlockup">softlockup与hardlockup</span>
            <span class="post-date" title="2025-02-25 22:13:35">2025/02/25</span>
        </a>
        
        
        <a  class="All 网络 "
           href="/2025/02/24/netpoll%E5%8E%9F%E7%90%86/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="netpoll原理">netpoll原理</span>
            <span class="post-date" title="2025-02-24 21:36:30">2025/02/24</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="Toggle full screen shortcut key s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-内核中的guard宏" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">内核中的guard宏</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="其他">其他</a>
            
        </span>
        
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2025-11-02 23:01:26'>2025-11-02 22:49</time>
        
    </div>
    <div class="article-meta">
        
        <span>Count:2.5k</span>
        
        
        
        <span class="top-comment" title="Jump to comment area">
            <a href="#comments">
                Comment:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8Egcc%E7%9A%84cleanup%E5%B1%9E%E6%80%A7%E5%BC%80%E5%A7%8B"><span class="toc-text">从gcc的cleanup属性开始</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84guard"><span class="toc-text">内核中的guard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a><center>背景</center></h3><p>最近看内核代码的时候，注意到之前不少加锁的地方都替换成了guard()</p>
<p>比如，我们看一下曾经某个commit的改动，很明显，这里就是把成对的preempt_{en,dis}able替换成了一个guard()。</p>
<pre><code class="language-c">@@ -2417,10 +2404,9 @@ void migrate_disable(void)
                return;
        &#125;

-       preempt_disable();
+       guard(preempt)();
        this_rq()-&gt;nr_pinned++;
        p-&gt;migration_disabled = 1;
-       preempt_enable();
</code></pre>
<p>但是，为什么可以这么替换？这个guard是怎么实现的？作用是什么？我们需要看一看，研究一下。</p>
<h3 id="从gcc的cleanup属性开始"><a href="#从gcc的cleanup属性开始" class="headerlink" title="从gcc的cleanup属性开始"></a><center>从gcc的cleanup属性开始</center></h3><p>在<a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html">https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html</a> 中，我们可以看到gcc支持cleanup这么一个属性</p>
<p>这里我没有查到具体哪个gcc版本引入的这个属性支持，但是我们可以明确，很早之前的版本就有了，<a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc-4.0.0/gcc/Variable-Attributes.html#index-g_t_0040code_007bcleanup_007d-attribute-1768">https://gcc.gnu.org/onlinedocs/gcc-4.0.0/gcc/Variable-Attributes.html#index-g_t_0040code_007bcleanup_007d-attribute-1768</a>  可以看到gcc 4.0.0就支持了这个属性，关于它的解释如下：</p>
<pre><code class="language-c">cleanup (cleanup_function)
The cleanup attribute runs a function when the variable goes out of scope. This attribute
can only be applied to auto function scope variables; it may not be applied to parameters
or variables with static storage duration. The function must take one parameter, a pointer
to a type compatible with the variable. The return value of the function (if any) is ignored.

When multiple variables in the same scope have cleanup attributes, at exit from the scope
their associated cleanup functions are run in reverse order of definition (last defined,
first cleanup).
</code></pre>
<p>什么意思呢？<font color="red">cleanup这个属性会在一个变量离开它的作用域后自动调用一个释放函数</font>。注意：本属性只能作用域function auto scope的变量，也就是说函数中定义的栈上分配的在函数作用域中的变量，参数或者static变量是不行的。自动调用的函数必须有一个参数，该参数是一个指向与该变量类型兼容的指针。如果某个作用域内有多个变量定义了cleanup属性，从作用域离开时，这些cleanup的函数的执行顺序是与变量的定义顺序相反的。看到这个是不是立刻想到了cpp的析构函数。</p>
<p>怎么使用呢？直接上一段代码看看：</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main()
&#123;
    char *A = malloc(8);

    strncpy(A, &quot;yzwddsg&quot;, 7);
    A[7] = &#39;\0&#39;;

    printf(&quot;%s\n&quot;, A);
    free(A);
    printf(&quot;%s\n&quot;, A);
&#125;
</code></pre>
<p>运行结果如下：</p>
<pre><code class="language-c">[root@yzwddsg tmp]# ./a
yzwddsg
        //这里其实有内容，是空，不建议这么写，测试用
</code></pre>
<p>上面的代码，我们申请了malloc的内存之后，需要手动使用free释放，否则就会发生内存泄漏。当然，上面的代码片段很简单，我们肯定不会忘记free，但是在复杂的大型的项目中，尤其是判断分支多的情况下，其实很在该释放内存的时候忘记使用free，如果改成下面这样，即使main中有大量判断分支，编译器也不会忘记在char *A离开作用域时自动调用free_A去释放内存。</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

void free_A (char **A)
&#123;
    free(*A);
&#125;

int main()
&#123;
    __attribute__((cleanup(free_A))) char *A = malloc(8);

    strncpy(A, &quot;yzwddsg&quot;, 7);
    A[7] = &#39;\0&#39;;

    printf(&quot;%s\n&quot;, A);
&#125;

//运行结果如下
[root@yzwddsg tmp]# ./a
yzwddsg
</code></pre>
<p>我们把上面两段没用的代码都去掉，只留主要的malloc</p>
<pre><code class="language-c">//第一段
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main()
&#123;
    char *A = malloc(8);

    free(A);
&#125;

//第二段
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

void free_A(char **A)
&#123;
    free(*A);
&#125;

int main()
&#123;
    __attribute__((cleanup(free_A))) char *A = malloc(8);
&#125;
</code></pre>
<p>然后我们分别反汇编第一段和第二段代码，查看其main函数</p>
<pre><code class="language-c">//第一段
00000000004011a5 &lt;main&gt;:
  4011a5:	55                   	push   %rbp
  4011a6:	48 89 e5             	mov    %rsp,%rbp
  4011a9:	48 83 ec 10          	sub    $0x10,%rsp
  4011ad:	bf 08 00 00 00       	mov    $0x8,%edi
  4011b2:	e8 a9 fe ff ff       	callq  401060 &lt;malloc@plt&gt;
  4011b7:	48 89 45 f8          	mov    %rax,-0x8(%rbp)
  4011bb:	48 8b 45 f8          	mov    -0x8(%rbp),%rax
  4011bf:	48 89 c7             	mov    %rax,%rdi
  4011c2:	e8 79 fe ff ff       	callq  401040 &lt;free@plt&gt;
  4011c7:	b8 00 00 00 00       	mov    $0x0,%eax
  4011cc:	c9                   	leaveq
  4011cd:	c3                   	retq
  4011ce:	66 90                	xchg   %ax,%ax


//第二段
00000000004011c3 &lt;main&gt;:
  4011c3:	55                   	push   %rbp
  4011c4:	48 89 e5             	mov    %rsp,%rbp
  4011c7:	48 83 ec 10          	sub    $0x10,%rsp
  4011cb:	bf 08 00 00 00       	mov    $0x8,%edi
  4011d0:	e8 8b fe ff ff       	callq  401060 &lt;malloc@plt&gt;
  4011d5:	48 89 45 f8          	mov    %rax,-0x8(%rbp)
  4011d9:	48 8d 45 f8          	lea    -0x8(%rbp),%rax
  4011dd:	48 89 c7             	mov    %rax,%rdi
  4011e0:	e8 c0 ff ff ff       	callq  4011a5 &lt;free_A&gt;
  4011e5:	b8 00 00 00 00       	mov    $0x0,%eax
  4011ea:	c9                   	leaveq
  4011eb:	c3                   	retq
  4011ec:	0f 1f 40 00          	nopl   0x0(%rax)
</code></pre>
<p>可以看到，使用cleanup属性之后，gcc编译器会自动在cleanup修饰的变量离开作用域的地方插入一个函数调用，指向我们自己写的free函数。不错，其实就是相当于<font color="red">我们自己手动写一个释放函数，然后在初始化变量的时候使用cleanup属性带上这个释放函数，编译器在编译时就会自动在所有需要释放的地方插入对改函数的掉调用以正确释放该变量，防止内存泄漏</font>。</p>
<h3 id="内核中的guard"><a href="#内核中的guard" class="headerlink" title="内核中的guard"></a><center>内核中的guard</center></h3><p>内核作为一个极其复杂的超超超大型c项目，一直都是需要手动在每个return或者goto去处理资源释放之类的操作，如果能用上cleanup岂不是美滋滋。</p>
<p>哎，<a target="_blank" rel="noopener" href="https://lwn.net/Articles/934679/">https://lwn.net/Articles/934679/</a> ，guard就是用上了这个属性。</p>
<p>我们直接看最初的commit吧，54da6a092431 (“locking: Introduce __cleanup() based infrastructure”)，看看这个实现过程：</p>
<ul>
<li><strong><strong>attribute</strong>((__cleanup()))与清理函数的封装</strong></li>
</ul>
<pre><code class="language-c">+#define DEFINE_FREE(_name, _type, _free) \
+       static inline void __free_##_name(void *p) &#123; _type _T = *(_type *)p; _free; &#125;
+
+#define __free(_name)  __cleanup(__free_##_name)
+
//这里解释下为什么这样封装一下
//如果需要封装一个指针变量，那么返回的时候是不是就自动释放了呢？
//为了防止上面这种情况，需要先把该指针赋值给一个新变量，然后返回这个新的变量，旧的指针置NULL
//这样，return的时候就返回了新的指针,cleanup调用函数去释放旧的NULL
+#define no_free_ptr(p) \
+       (&#123; __auto_type __ptr = (p); (p) = NULL; __ptr; &#125;)
+
+#define return_ptr(p)  return no_free_ptr(p)



+#define __cleanup(func)                        __attribute__((__cleanup__(func)))
</code></pre>
<p>上面先定义了一些宏，使用这些宏，我们可以很容易构造出一个自动释放的函数（就是cleanup属性自动调用的释放函数，比如上面例子中的free_A）</p>
<p>比如，还是我们之前的例子：</p>
<pre><code class="language-c">//之前是这样写的
void free_A(char **A)
&#123;
    free(*A);
&#125;

int main()
&#123;
    __attribute__((cleanup(free_A))) char *A = malloc(8);
&#125;


//使用这些封装之后，在内核里可以这样写(举个例子，其实不能直接写到内核中)
DEFINE_FREE(free_A, char *, free(_T))  //注意这里是char *，不是char **了，已经对类型做了封装

int main()
&#123;
    __cleanup(free_A) char *A = malloc(8);   //这里直接使用__cleanup就把__attribute__((__cleanup__(XXX)))封装了
&#125;
</code></pre>
<ul>
<li><strong>class的实现</strong></li>
</ul>
<p>能不能再抽象一点呢？搞一个类，为一个类型定义destructor和constructor</p>
<pre><code class="language-c">+#define DEFINE_CLASS(_name, _type, _exit, _init, _init_args...)                \
+typedef _type class_##_name##_t;                                       \
+static inline void class_##_name##_destructor(_type *p)                        \
+&#123; _type _T = *p; _exit; &#125;                                              \
+static inline _type class_##_name##_constructor(_init_args)            \
+&#123; _type t = _init; return t; &#125;
+
+#define EXTEND_CLASS(_name, ext, _init, _init_args...)                 \
+typedef class_##_name##_t class_##_name##ext##_t;                      \
+static inline void class_##_name##ext##_destructor(class_##_name##_t *p)\
+&#123; class_##_name##_destructor(p); &#125;                                     \
+static inline class_##_name##_t class_##_name##ext##_constructor(_init_args) \
+&#123; class_##_name##_t t = _init; return t; &#125;
+
+#define CLASS(_name, var)                                              \
+       class_##_name##_t var __cleanup(class_##_name##_destructor) =   \
+               class_##_name##_constructor

//比如，这样使用
//DEFINE_CLASS中，为struct fd定义了一个别名class_fdget_t类型
//定一个一个class_fdget_destructor函数，执行fdput(_T)
//定义了一个class_fdget_constructor函数，执行fdget(fd)函数
//CLASS则直接初始化了一个class_fdget_t类型的f变量，并附带上了cleanup属性，也就是离开作用域自动释放
//这样，使用f的时候就不用担心有忘记释放的情况了
+ * DEFINE_CLASS(fdget, struct fd, fdput(_T), fdget(fd), int fd)
+ *
+ *     CLASS(fdget, f)(fd);
+ *     if (!f.file)
+ *             return -EBADF;
+ *
+ *     // use &#39;f&#39; without concern
+ */
</code></pre>
<ul>
<li><strong>在内核中用起来</strong></li>
</ul>
<p>上面虽然实现了对cleanup的封装和更高层的抽象，但是我们总不想每次使用都这么麻烦吧，而且用在哪里呢？有什么使用场景呢？</p>
<p>下面是对lock的一层封装的实现</p>
<pre><code class="language-c">+#define DEFINE_GUARD(_name, _type, _lock, _unlock) \
+       DEFINE_CLASS(_name, _type, _unlock, (&#123; _lock; _T; &#125;), _type _T)
+
+#define guard(_name) \
+       CLASS(_name, __UNIQUE_ID(guard))     //这里的__UNIQUE_ID是为了生成唯一的标识符名称，不做展开
+
+#define scoped_guard(_name, args...)                                   \
+       for (CLASS(_name, scope)(args),                                 \
+            *done = NULL; !done; done = (void *)1)


//所以，这里可以明白，只要再对一些类型的锁做一层DEFINE_GUARD的封装，就可以使用起来了
//比如，我们看看最开始提到的guard(preempt)();，看看它是怎么实现的
//我们看最开始就是使用DEFINE_LOCK_GUARD_0把preempt、preempt_disable(), preempt_enable()进行了封装
//DEFINE_LOCK_GUARD_0会调用__DEFINE_UNLOCK_GUARD宏和__DEFINE_LOCK_GUARD_0宏
//__DEFINE_UNLOCK_GUARD宏定义了一个class_preempt_t类型，然后定义了class_preempt_destructor函数，执行的其实就是preempt_enable()
//__DEFINE_LOCK_GUARD_0就是定义一个 class_preempt_constructor函数，初始化class_preempt_t结构体，其实里面就一个把void *lock赋值一下，然后执行preempt_disable()

//然后，当我们再去调用guard(preempt)();的时候，其实就是初始化了一个class_preempt_t结构体(在这里没什么用)，然后执行preempt_disable()
//然后因为初始化的时候带上了cleanup属性，所以在离开class_preempt_t结构体变量的作用域的时候，就自动调用preempt_enable()

+#define DEFINE_LOCK_GUARD_0(_name, _lock, _unlock, ...)                        \
+__DEFINE_UNLOCK_GUARD(_name, void, _unlock, __VA_ARGS__)               \
+__DEFINE_LOCK_GUARD_0(_name, _lock)

+#define __DEFINE_UNLOCK_GUARD(_name, _type, _unlock, ...)              \
+typedef struct &#123;                                                       \
+       _type *lock;                                                    \
+       __VA_ARGS__;                                                    \
+&#125; class_##_name##_t;                                                   \
+                                                                       \
+static inline void class_##_name##_destructor(class_##_name##_t *_T)   \
+&#123;                                                                      \
+       if (_T-&gt;lock) &#123; _unlock; &#125;                                      \
+&#125;

+#define __DEFINE_LOCK_GUARD_0(_name, _lock)                            \
+static inline class_##_name##_t class_##_name##_constructor(void)      \
+&#123;                                                                      \
+       class_##_name##_t _t = &#123; .lock = (void*)1 &#125;,                    \
+                        *_T __maybe_unused = &amp;_t;                      \
+       _lock;                                                          \
+       return _t;                                                      \
+&#125;


DEFINE_LOCK_GUARD_0(preempt, preempt_disable(), preempt_enable())
</code></pre>
<p>所以，其实guard就是对一些变量(并不一定局限于变量，比如上面这个preempt_{en,dis}able这种，其实就在class的封装下可以使用上cleanup的特性)做一下封装，主要是带上cleanup属性，能够让我们避免在goto return等复杂函数体中自己维护这些变量的初始化及释放等操作。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a><center>参考</center></h3><p><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html">https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html</a></p>
<p><a target="_blank" rel="noopener" href="https://echorand.me/site/notes/articles/c_cleanup/cleanup_attribute_c.html">https://echorand.me/site/notes/articles/c_cleanup/cleanup_attribute_c.html</a></p>
<p><a target="_blank" rel="noopener" href="https://omeranson.github.io/blog/2022/06/12/cleanup-attribute-in-C">https://omeranson.github.io/blog/2022/06/12/cleanup-attribute-in-C</a></p>
<p><a target="_blank" rel="noopener" href="https://matteocroce.it/blog/c-cleanups/">https://matteocroce.it/blog/c-cleanups/</a></p>
<p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/934679/">https://lwn.net/Articles/934679/</a></p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 857879363@qq.com </span>
    </div>
</article>





    <div id="comments"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script type="text/javascript">
    $.getScript('/js/gitalk.js', function () {
        var gitalk = new Gitalk({
            clientID: 'Ov23lihTjDF3jklWOX9b',
            clientSecret: '1304f65e90138886cd32255710839a4ba192f266',
            repo: 'yzwddsg-plus.github.io',
            owner: 'yzwddsg-plus',
            admin: ['yzwddsg-plus'],
            id: decodeURI(location.pathname),
            distractionFreeMode: 'true',
            language: 'zh-CN',
            perPage: parseInt('10',10)
        })
        gitalk.render('comments')
    })
</script>







    </div>
    <div class="copyright">
        <p class="footer-entry">
    YZWDDSG
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="Toggle full screen shortcut key s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
    #post .pjax article :not(pre) > code {
        color: #24292e;
        font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;
        background-color: rgba(27,31,35,.05);
        border-radius: 3px;
        font-size: 85%;
        margin: 0;
        padding: .2em .4em;
    }
    
</style>







</html>
